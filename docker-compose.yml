services:
  ingest:
    build:
      context: ./ingest
      dockerfile: Dockerfile
  

    env_file:
      - .env

    environment:
      INFLUX_URL: "http://influxdb:8086"
      PYTHONPATH: /app/ingest/src
      LOG_LEVEL: INFO
      LOG_DIR: /app/logs 
        
      EON_TOKEN_PATH: "/app/secrets/token.json"
      EON_SOURCE_CONFIG_PATH: "/app/config/source_config.json"

    networks:
      - power_meter_net
      
    volumes:
      - ./secrets:/app/secrets
      - ./state:/app/state
      - ./config:/app/config
      - ./logs:/app/logs
      - ./ingest/src:/app/ingest/src:ro

    # one-shot futás: a CMD-t a Dockerfile is adhatja, itt felülírhatod
    command: ["python", "-m", "ingest.jobs.daily"]
    restart: "no"

networks:
  power_meter_net:
    external: true