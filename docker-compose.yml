services:
  ingest:
    build:
      context: ./ingest
      dockerfile: Dockerfile
    container_name: power-meter-ingest

    env_file:
      - .env

    environment:
      INFLUX_URL: "http://influxdb:8086"
      PYTHONPATH: /app/ingest/src
      EON_TOKEN_PATH: "/app/.power_meter/eon/token.json"
      EON_SOURCE_CONFIG_PATH: "/app/.power_meter/eon/source_config.json"

    networks:
      - power_meter_net

    volumes:
      - ./.power_meter:/app/.power_meter
      - ./state:/app/state
      - ./ingest/src:/app/ingest/src:ro

    # one-shot futás: a CMD-t a Dockerfile is adhatja, itt felülírhatod
    command: ["python", "-m", "ingest.jobs.debug_eon"]
    restart: "no"

networks:
  power_meter_net:
    external: true